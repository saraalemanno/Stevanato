<!DOCTYPE html>
<html>
<head>
    <title>Bucintoro Auto Test</title>
    <link rel="icon" href="/static/favicon.ico">
    <style>
        body { font-family: Arial; margin: 20px; }
        .device-block { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
        textarea { width: 100%; height: 200px; margin-top: 10px; }
        input, button { padding: 5px; margin-top: 5px 0; }
        #runAutoLoopTest { transition: all 0.2s ease-in-out; background-color: rgb(181, 238, 181); border: 2px solid green; color: black;}
        #runAutoLoopTest:hover { transform: scale(1.05); background-color: rgb(181, 238, 181); cursor: pointer; }
        #runAutoLoopTest.stop-button1 { transition: all 0.2 ease-in-out; background-color: rgb(252, 186, 186); border: 2px solid red; color: black; }
        #runAutoLoopTest.stop-button1:hover { transform: scale(1.05); background-color: rgb(252, 186, 186); cursor: pointer; }
        .download-button1 { transition: all 0.2s ease-in-out; background-color: lightyellow; border: 2px solid orange; color: black; }
        .download-button1:hover { transform: scale(1.05); background-color: lightyellow; cursor: pointer; }
        .downloadlog-button1 { transition: all 0.2s ease-in-out; background-color: lightgray; border: 2px solid orange; color: black; }
        .downloadlog-button1:hover { transform: scale(1.05); background-color: lightgray; cursor: pointer; }
        #runCompleteTest { transition: all 0.2s ease-in-out; background-color: rgb(181, 238, 181); border: 2px solid green; color: black;}
        #runCompleteTest:hover { transform: scale(1.05); background-color: rgb(181, 238, 181); cursor: pointer; }
        #runCompleteTest.stop-button2 { transition: all 0.2 ease-in-out; background-color: rgb(252, 186, 186); border: 2px solid red; color: black; }
        #runCompleteTest.stop-button2:hover { transform: scale(1.05); background-color: rgb(252, 186, 186); cursor: pointer; }
        .download-button2 { transition: all 0.2s ease-in-out; background-color: lightyellow; border: 2px solid orange; color: black; }
        .download-button2:hover { transform: scale(1.05); background-color: lightyellow; cursor: pointer; }
        .downloadlog-button2 { transition: all 0.2s ease-in-out; background-color: lightgray; border: 2px solid orange; color: black; }
        .downloadlog-button2:hover { transform: scale(1.05); background-color: lightgray; cursor: pointer; }

    </style>
</head>
<body>
    <div style="display: flex; align-items: center; justify-content: space-between;"> 
        <h2 style="background-color:orange; padding: 15px; border-radius: 10px; display: inline-block;">Bucintoro Tests: Autoloop Test or Complete test</h2>
        <img src="/static/header-logo.svg" alt="Logo Bucintoro" style="height: 80px;">
    </div>
    <div id="devices"></div>
    <div style="display: flex; flex-direction: column; gap: 10px; font-size: 120%; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <label for="numCamere" style="width: 500px;">
                Number of connected <b>Timing Controller</b> modules (1-10):
            </label>
            <input type="number" id="numCamere" name="numCamere" min="1" max="10" value="1" style="padding: 5px;">
        </div>

        <div style="display: flex; align-items: center; gap: 10px;">
            <label for="numGalvo" style="width: 500px;">
                Number of connected <b>Galvo</b> modules (1-10):
            </label>
            <input type="number" id="numGalvo" name="numGalvo" min="1" max="10" value="1" style="padding: 5px;">
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <label for="environment" style="width: 500px;">
                Select Environment (Backend + API):
            </label>
            <select id="environment" name="environment" style="padding: 5px;">
                <option value="standard">Standard</option>
                <option value="custom">Custom</option>
            </select>
        </div>
        <div id="customConfig" style="display:none; margin-top: 10px;">
            <label>Custom Backend IP:</label>
            <input type="text" id="customBackend" placeholder="X.X.X.X">

            <label>Custom PLC IP:</label>
            <input type="text" id="customPlc" placeholder="X.X.X.X">
        </div>
    </div>
    <div id="serialNumberContainer"></div>
    <div style="margin-top: 20px; display: flex; gap: 20px;">
        <button id="runAutoLoopTest" onclick="RunAutoLoopTest()" style="display: flex; align-items: center; gap: 10px; padding: 10px 58px; font-size: 16px;"><img src="/static/play-button.png" alt="Play" style="height: 25px; vertical-align: bottom;">Run Auto Loop Test</button>
        <button class="download-button1" onclick="downloadReport()" style="display: flex; align-items: center; gap: 10px; padding: 10px 20px; font-size: 16px;"><img src="/static/download3.png" alt="Play" style="height: 25px; vertical-align: bottom;">Download Complete Report</button>
        <button class="downloadlog-button1" onclick="downloadLog()" style="display: flex; align-items: center; gap: 10px; padding: 10px 20px; font-size: 16px;"><img src="/static/download3.png" alt="Play" style="height: 25px; vertical-align: bottom;">Download Log</button>
    </div>
    <div style="margin-top: 20px; display: flex; gap: 20px;">
        <button id="runCompleteTest" onclick="RunCompleteTest()" style="display: flex; align-items: center; gap: 10px; padding: 10px 20px; font-size: 16px;"><img src="/static/play-button.png" alt="Play" style="height: 25px; vertical-align: bottom;">Run Complete Simulation Test</button>
        <button class="download-button2" onclick="downloadReport()" style="display: flex; align-items: center; gap: 10px; padding: 10px 20px; font-size: 16px;"><img src="/static/download3.png" alt="Play" style="height: 25px; vertical-align: bottom;">Download Complete Report</button>
        <button class="downloadlog-button2" onclick="downloadLog()" style="display: flex; align-items: center; gap: 10px; padding: 10px 20px; font-size: 16px;"><img src="/static/download3.png" alt="Play" style="height: 25px; vertical-align: bottom;">Download Log</button>
    </div>
    <h3>Console Output:</h3>
    <div id="consoleOutput" style="white-space: pre-wrap; background-color: #f0f0f0; padding: 10px; border: 1px solid #ccc;"></div>
    <script>
        document.getElementById("environment").addEventListener("change", function() {
            const env = this.value;
            document.getElementById("customConfig").style.display = 
                env === "custom" ? "block" : "none";
        });
    </script>
    <script src= "/static/socket.io.min.js"></script>
    <script>
        function updateSerialInputs() {
            const numCamere = parseInt(document.getElementById("numCamere").value);
            const numGalvo = parseInt(document.getElementById("numGalvo").value);
            const container = document.getElementById("serialNumberContainer");

            container.innerHTML = "";

            const mainSection = document.createElement("div");
            mainSection.innerHTML = "<h3 style='font-size: 140%;'>Main Module Serial Number</h3>";

            const inputMain = document.createElement("div");
            inputMain.style.display = "flex";
            inputMain.style.alignItems = "center";
            inputMain.style.gap = "10px";
            inputMain.style.marginBottom = "10px";

            const mainLabel = document.createElement("label");
            mainLabel.innerHTML = "Main <i>Serial Number</i>: ";
            mainLabel.style.fontSize = "120%";
            mainLabel.style.width = "310px";
            const mainInput = document.createElement("input");
            mainInput.type = "text";
            mainInput.name = "mainSerial";
            mainInput.id = "mainSerial";
            mainInput.style.padding = "5px";

            inputMain.appendChild(mainLabel);
            inputMain.appendChild(mainInput);
            mainSection.appendChild(inputMain);
            container.appendChild(mainSection);

            const cameraSection = document.createElement("div");
            cameraSection.innerHTML = "<h3 style='font-size: 140%;'>Timing Controller Modules Serial Numbers</h3>";
            for (let i = 1; i <= numCamere; i++) {
                const inputTC = document.createElement("div");
                inputTC.style.display = "flex";
                inputTC.style.alignItems = "center";
                inputTC.style.gap = "10px";
                inputTC.style.marginBottom = "10px";

                const label = document.createElement("label");
                label.innerHTML = `Timing Controller ${i+19} <i>Serial Number</i>: `;
                label.style.fontSize = "120%";
                label.style.width = "310px";

                const input = document.createElement("input");
                input.type = "text";
                input.name = `cameraSerial${i}`;
                input.id = `cameraSerial${i}`;
                input.style.padding = "5px";

                inputTC.appendChild(label);
                inputTC.appendChild(input);
                cameraSection.appendChild(inputTC);
            }
            container.appendChild(cameraSection);

            
            const galvoSection = document.createElement("div");
            galvoSection.innerHTML = "<h3 style='font-size: 140%;'>Galvo Modules Serial Numbers</h3>";
            for (let i = 1; i <= numGalvo; i++) {
                const inputG = document.createElement("div");
                inputG.style.display = "flex";
                inputG.style.alignItems = "center";
                inputG.style.gap = "10px";
                inputG.style.marginBottom = "10px";

                const label = document.createElement("label");
                label.innerHTML = `Galvo ${i+29} <i>Serial Number</i>: `;
                label.style.fontSize = "120%";
                label.style.width = "310px";

                const input = document.createElement("input");
                input.type = "text";
                input.name = `galvoSerial${i}`;
                input.id = `galvoSerial${i}`;
                input.style.padding = "5px";

                inputG.appendChild(label);
                inputG.appendChild(input);
                galvoSection.appendChild(inputG);
            }
            container.appendChild(galvoSection);
        }

        document.getElementById("numCamere").addEventListener("change", updateSerialInputs);
        document.getElementById("numGalvo").addEventListener("change", updateSerialInputs);
        window.addEventListener("DOMContentLoaded", updateSerialInputs);
        function getEnvironmentConfig() {
            const env = document.getElementById("environment").value;

            if (env === "custom") {
                return {
                    env: "custom",
                    BACKEND_IP: document.getElementById("customBackend").value,
                    IP_PLC: document.getElementById("customPlc").value
                };
            }

            return { env: env };
        }

        let autotest_in_progress = false;
        async function RunAutoLoopTest() {
            const button = document.getElementById('runAutoLoopTest');
            const consoleDiv = document.getElementById('consoleOutput');
            const numCamere = parseInt(document.getElementById('numCamere').value);
            const numGalvo = parseInt(document.getElementById('numGalvo').value);

            const mainSerial = document.getElementById(`mainSerial`).value;
            const cameraSerials = [];
            const galvoSerials = [];
            
            for (let i = 1; i <= numCamere; i++) {
                const val = document.getElementById(`cameraSerial${i}`).value || "";
                cameraSerials.push(val);
            }
            for (let i = 1; i <= numGalvo; i++) {
                const val = document.getElementById(`galvoSerial${i}`).value || "";
                galvoSerials.push(val);
            }

            if (!autotest_in_progress) {
                autotest_in_progress = true;
                button.innerHTML = "<img src='/static/stop.png' alt='Stop' style='height: 25px'> Stop Auto Loop Test";
                button.classList.add("stop-button1");
                consoleDiv.innerHTML += "<br><strong>Bucintoro Auto Loop Test Output:</strong><br>";
                try{
                    const response = await fetch('/run_test_loop_bucintoro', {
                        method: 'POST',
                         headers: {
                            'Content-Type': 'application/json'
                         },
                         body: JSON.stringify({
                            numCamere,
                            numGalvo,
                            mainSerial,
                            cameraSerials,
                            galvoSerials,
                            ...getEnvironmentConfig()
                         }) 
                    });
                    const result = await response.json();
                    consoleDiv.innerHTML += result.output;
                    if (result.reportPath) {
                        consoleDiv.setAttribute('data-report-path', result.reportPath);
                        consoleDiv.innerHTML += `<br>Report generated<br>`;
                    }
                    if (result.summary && Array.isArray(result.summary)) {
                        const summaryTable = document.createElement('table');
                        summaryTable.style.borderCollapse = 'collapse';
                        summaryTable.style.marginTop = '10px';
                        summaryTable.style.width = '100%';
                        const headerRow = document.createElement('tr');
                        ['Device', 'Test', 'Result'].forEach(headerText => {
                            const th = document.createElement('th');
                            th.innerText = headerText;
                            th.style.border = '1px solid #000';
                            th.style.padding = '8px';
                            th.style.backgroundColor = '#f2f2f2';
                            headerRow.appendChild(th);
                        });
                        summaryTable.appendChild(headerRow);
                        result.summary.forEach(item => {
                            const row = document.createElement('tr');
                            const tdDevice = document.createElement('td');
                            tdDevice.innerText = item.device || '';
                            tdDevice.style.border = '1px solid #000';
                            tdDevice.style.padding = '8px';
                            row.appendChild(tdDevice);
                            const tdTest = document.createElement('td');
                            tdTest.innerText = item.test || '';
                            tdTest.style.border = '1px solid #000';
                            tdTest.style.padding = '8px';
                            row.appendChild(tdTest);
                            const tdResult = document.createElement('td');
                            tdResult.innerText = item.result || '';
                            tdResult.style.border = '1px solid #000';
                            tdResult.style.padding = '8px';
                            row.appendChild(tdResult);
                            summaryTable.appendChild(row);
                        });
                        consoleDiv.appendChild(summaryTable);
                    }
                    if (result.logPath) {
                        consoleDiv.setAttribute('data-log-path', result.logPath);
                    }
                } catch (error) {
                    console.error = ("Error during Bucintoro Auto Loop Test:", error);
                    alert('Error during Bucintoro Auto Loop Test: ');
                } finally {
                    autotest_in_progress = false;
                    button.innerHTML = "<img src='/static/play-button.png' alt='Play' style='height:25px'> Run Auto Loop Test";
                    button.classList.remove("stop-button1");
                }
            } else {
                try {
                    const response = await fetch('/stop_test_loop_bucintoro', { method: 'POST' });
                    const result = await response.json();
                    alert(result.status);
                } catch (error) {
                    console.error("Error stopping Bucintoro Auto Loop Test:", error);
                } finally {
                    test_i2c_in_progress = false;
                    button.innerHTML = "<img src='/static/play-button.png' alt='Play' style='height:25px'> Run Auto Loop Test";
                    button.classList.remove("stop-button1");
                }
            }
        }

        let simulation_in_progress = false;
        async function RunCompleteTest() {
            const button = document.getElementById('runCompleteTest');
            const consoleDiv = document.getElementById('consoleOutput');
            const numCamere = parseInt(document.getElementById('numCamere').value);
            const numGalvo = parseInt(document.getElementById('numGalvo').value);

            const mainSerial = document.getElementById(`mainSerial`).value;
            const cameraSerials = [];
            const galvoSerials = [];
            
            for (let i = 1; i <= numCamere; i++) {
                const val = document.getElementById(`cameraSerial${i}`).value || "";
                cameraSerials.push(val);
            }
            for (let i = 1; i <= numGalvo; i++) {
                const val = document.getElementById(`galvoSerial${i}`).value || "";
                galvoSerials.push(val);
            }

            if (!simulation_in_progress) {
                simulation_in_progress = true;
                button.innerHTML = "<img src='/static/stop.png' alt='Stop' style='height: 25px'> Stop Complete Simulation Test";
                button.classList.add("stop-button2");
                consoleDiv.innerHTML += "<br><strong>Complete Simulation Test Output:</strong><br>";
                try{
                    const response = await fetch('/run_complete_test_bucintoro', {
                        method: 'POST',
                         headers: {
                            'Content-Type': 'application/json'
                         },
                         body: JSON.stringify({
                            numCamere,
                            numGalvo,
                            mainSerial,
                            cameraSerials,
                            galvoSerials,
                            ...getEnvironmentConfig()
                         }) 
                    });
                    const result = await response.json();
                    consoleDiv.innerHTML += result.output;
                    if (result.reportPath) {
                        consoleDiv.setAttribute('data-report-path', result.reportPath);
                        consoleDiv.innerHTML += `<br>Report generated<br>`;
                    }
                    if (result.logPath) {
                        consoleDiv.setAttribute('data-log-path', result.logPath);
                    }
                } catch (error) {
                    console.error = ("Error during Complete Simulation Test:", error);
                    alert('Error during Complete Simulation Test: ');
                } finally {
                    simulation_in_progress = false;
                    button.innerHTML = "<img src='/static/play-button.png' alt='Play' style='height:25px'> Run Complete Simulation Test";
                    button.classList.remove("stop-button2");
                }
            } else {
                try {
                    const response = await fetch('/stop_complete_test_bucintoro', { method: 'POST' });
                    const result = await response.json();
                    alert(result.status);
                } catch (error) {
                    console.error("Error stopping Complete Simulation Test:", error);
                } finally {
                    simulation_in_progress = false;
                    button.innerHTML = "<img src='/static/play-button.png' alt='Play' style='height:25px'> Run Complete Simulation Test";
                    button.classList.remove("stop-button2");
                }
            }
        }


        function downloadReport() {
            const reportPath = document.getElementById('consoleOutput').getAttribute('data-report-path');
            if (reportPath) {
                window.location.href = '/download-report?path=' + encodeURIComponent(reportPath);
                consoleDiv.innerHTML += `<br>Report saved to: <a href="/download-report?path=${encodeURIComponent(result.reportPath)}">${result.reportPath}</a>`;
            } else {
                alert('No report available to download.');
            }
        }

        function downloadLog() {
            const logPath = document.getElementById('consoleOutput').getAttribute('data-log-path');
            if (logPath) {
                window.location.href = '/download-log?path=' + encodeURIComponent(logPath);
                consoleDiv.innerHTML += `<br>Log saved to: <a href="/download-log?path=${encodeURIComponent(result.logPath)}">${result.logPath}</a>`;
            } else {
                alert('No log available to download.');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();
            socket.on('test_output', function(data) {
                const outputDiv = document.getElementById('consoleOutput');
                if (outputDiv) {
                outputDiv.innerHTML += data.line + '<br>';
                }
            });
        });

    </script>
</body>
</html>